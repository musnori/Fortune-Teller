{% extends 'base.html' %}

{% block title %}運ポグラフ - 運ポちゃん{% endblock %}

{% block nav_graph %}active{% endblock %}

{% block body %}
<div class="fade-in">
    <!-- Header -->
    <header class="text-center mb-xl">
        <h1 class="page-title">運ポグラフ</h1>
        <p class="page-subtitle">7日間のポイント推移</p>
    </header>

    <!-- Graph Card -->
    <div class="glass-card slide-up">
        <div class="graph-header">
            <span class="graph-period">直近7日間</span>
            <button onclick="downloadImg()" class="btn btn-sm btn-outline" id="downloadBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                保存
            </button>
        </div>

        <!-- Chart Container -->
        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-label">合計</span>
                <span class="stat-value" id="totalPoints">--</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">平均</span>
                <span class="stat-value" id="avgPoints">--</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">最高</span>
                <span class="stat-value" id="maxPoints">--</span>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="btn-group mt-xl">
        <a href="/create" class="btn btn-primary btn-lg" style="flex: 1;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            記録を追加
        </a>
        <a href="/pre_graph" class="btn btn-secondary btn-lg" style="flex: 1;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 2v10l7 4"/>
            </svg>
            運勢診断
        </a>
    </div>
</div>

<style>
    .graph-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-lg);
    }

    .graph-period {
        font-size: var(--font-size-sm);
        opacity: 0.7;
    }

    .chart-container {
        position: relative;
        height: 250px;
        margin-bottom: var(--space-xl);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-md);
        padding-top: var(--space-lg);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-item {
        text-align: center;
    }

    .stat-label {
        display: block;
        font-size: var(--font-size-xs);
        opacity: 0.6;
        margin-bottom: var(--space-xs);
    }

    .stat-value {
        font-size: var(--font-size-xl);
        font-weight: 700;
    }

    .stat-value.positive {
        color: var(--accent-light);
    }

    .stat-value.negative {
        color: var(--secondary-light);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Data from Flask
    const labels = {{ day | tojson }};
    const data = {{ point | tojson }};

    // Calculate stats
    const total = data.reduce((a, b) => a + b, 0);
    const avg = data.length ? (total / data.length).toFixed(1) : 0;
    const max = data.length ? Math.max(...data) : 0;

    document.getElementById('totalPoints').textContent = total + 'P';
    document.getElementById('avgPoints').textContent = avg + 'P';
    document.getElementById('maxPoints').textContent = max + 'P';

    // Apply colors based on values
    if (total >= 0) document.getElementById('totalPoints').classList.add('positive');
    else document.getElementById('totalPoints').classList.add('negative');

    // Chart.js config
    const ctx = document.getElementById('myChart').getContext('2d');

    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
    gradient.addColorStop(0, 'rgba(129, 140, 248, 0.5)');
    gradient.addColorStop(1, 'rgba(129, 140, 248, 0)');

    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.reverse(),
            datasets: [{
                label: '運ポイント',
                data: data.reverse(),
                borderColor: '#818cf8',
                backgroundColor: gradient,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#818cf8',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 30, 40, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + 'P';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value + 'P';
                        }
                    },
                    beginAtZero: true
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });

    // Download function
    function downloadImg() {
        const canvas = document.getElementById('myChart');
        const link = document.createElement('a');
        link.download = 'fortune-graph.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    }
</script>
{% endblock %}
