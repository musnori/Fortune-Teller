{% extends 'base.html' %}
<html lang="ja" dir="ltr"></html>

{% block header %}
<meta charset="utf-8">
<title>グラフ</title> 
{% endblock %}

{% block headline %}
<h2 class="headline" style="text-align: center; position: relative;">一週間の運ポグラフ</h2>
<link rel="stylesheet" href="{{ url_for('static', filename='css/stylesheet.css') }}">
<img src="static/img/Fortune-Teller-rogo.png" alt="カネケン " title="カネケンロゴ" style="width:16% ;
height:12%; position:absolute; left:82%;  bottom:88%;" >


<style type="text/css">
.headline{
    background-color:#3C3A38;
    color:#f5f4ef;
    padding : 1.4em;
    font-family: serif ;
}
</style>

{% endblock %}



{% block body %}
<h1>運ポグラフ</h1>
<label for="due">日付</label>
<input type="date" id="Regist_Date" name="date" required>

<a class="btn btn-secondary" href="/" role="button">Return</a>

<!-- 画像保存 -->
<a onclick="downloadImg()" id="download" class="btn btn-primary">画像ダウンロード</a>

<!-- グラフ描画エリア -->
<canvas id="myChart"></canvas>

<!-- 画像保存に関係 -->
<img id="myChart_img" src="" />
<br />
<a id="myChart_imglink" href=""></a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js" integrity="sha512-vBmx0N/uQOXznm/Nbkp7h0P1RfLSj0HQrFSzV8m7rOGyj30fYAOKHYvCNez+yM8IrfnW0TCodDEjRqf6fodf/Q==" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css" integrity="sha512-/zs32ZEJh+/EO2N1b0PEdoA10JkdC3zJ8L5FTiQu82LR9S/rOQNfQN7U59U9BC12swNeRAz3HSzIL2vpp4fv3w==" crossorigin="anonymous" />

<script>
  var ctx = document.getElementById("myChart");
  var labels1 = new Object();
  var data1 = new Object();

  labels1.list = {{ day | tojson }};
  data1.list = {{ point | tojson}};
  
  var myChart = new Chart(ctx, {
    //線グラフ
    type: "line",
    //データ
    data: {
      //各データの時間
      labels : labels1.list,
      //データセット
      datasets: [
        {
          label: "運ポイント",
          lineTension: 0,
          data : data1.list,
          borderColor: "rgba(0, 0, 255, 1)", //線の色
          backgroundColor: "rgba(0, 0, 0, 0)" //塗りつぶしの色
        }
      ]
    },
    //グラフ設定
    options: {
      //凡例は非表示
      legend: {
        display: false
      },
      scales: {
        //X軸
        xAxes: [
          {
            gridLines: {
              drawOnChartArea: false,
              color: "#000000"
          },

            //軸ラベル表示
            scaleLabel: {
              display: true,
              labelString: "日付",
              fontColor: "#000000",
              fontSize: 30
            },
            //ここで軸を時間を設定する
            type: "time",
            time: {
              // parser: "hh:mm",
              unit: "day",
            },
            //X軸の範囲を指定
            ticks: {
              fontColor: "#000000",
              fontSize: 20
            }
          }
        ],
        //Y軸
        yAxes: [
          {
            gridLines: {
              drawOnChartArea: false,
              color: "#000000"
          },
            //軸ラベル表示
            scaleLabel: {
              display: true,
              labelString: "運ポ",
              fontColor: "#000000",
              fontSize: 30
            },
            //Y軸の範囲を指定
            ticks: {
              min: 0,
              max: 6,
              fontColor: "#000000",
              fontSize: 20
            }
          }
        ]
      }
    }
  });

  // 画像化
  var image = myChart.toBase64Image();
  document.getElementById('myChart_img').setAttribute('src', image);
  document.getElementById('myChart_imglink').setAttribute('href', image);


  var canvas = document.getElementById('myChart');
  function downloadImg(){
    let link = document.getElementById("download");
    link.href= canvas.toDataURL('image/png');
    link.download = 'img.jpg';
}
  
  var date = new Date();
  
  // 「年月日」を配列で取得 ( [0]:年, [1]:月, [2]:日 )
  var dateArray = getTSDate(date);

  // 登録日付に「本日の年月日」を設定
  document.getElementById("Regist_Date").value = dateArray[0] + "-" + dateArray[1] + "-" + dateArray[2]


  /**
   *  タイムスタンプから年月日文字列を取得
   */       
  function getTSDate(date){
      var dateArray = new Array();
      dateArray.push(zero_pad(date.getFullYear(),4));
      dateArray.push(zero_pad(date.getMonth() + 1,2));
      dateArray.push(zero_pad(date.getDate(),2));
      return dateArray;
  }
  
  /**
   *  ０詰処理
   */
  function zero_pad(val, show_length){
      var str_val = String(val);
      if( str_val.length < show_length ){
          var zero = ""; 
          for(var i = 0; i < ( show_length - str_val.length ); i++){
              zero += "0";
          }
          str_val = zero + str_val;
      }
      return str_val;
  };

</script>
 
{% endblock %}