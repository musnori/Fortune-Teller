<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>履歴 - 運勢トラッカー</title>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation">
        <div class="bg-gradient"></div>
        <div class="floating-shapes">
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Delete Confirmation Dialog -->
    <div class="dialog-overlay" id="deleteDialog">
        <div class="dialog">
            <h3 class="dialog-title" data-i18n="history.confirmDelete">この記録を削除しますか？</h3>
            <p class="dialog-message">この操作は取り消せません。</p>
            <div class="dialog-actions">
                <button class="btn btn-secondary" onclick="closeDeleteDialog()">キャンセル</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">削除</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="app-container">
        <div class="fade-in">
            <!-- Header -->
            <header class="app-header">
                <h1 class="app-title" data-i18n="history.title">履歴</h1>
            </header>

            <!-- Search -->
            <div class="search-input-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" class="search-input" id="searchInput"
                       data-i18n-placeholder="history.search.placeholder"
                       placeholder="タイトル・メモで検索">
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs" id="filterTabs">
                <button class="filter-tab active" data-filter="all" data-i18n="history.filter.all">すべて</button>
                <button class="filter-tab" data-filter="effort" data-i18n="history.filter.effort">努力</button>
                <button class="filter-tab" data-filter="goodThing" data-i18n="history.filter.goodThing">良いこと</button>
            </div>

            <!-- History List -->
            <div class="history-list slide-up" id="historyList">
                <!-- Entries will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <span data-i18n="nav.home">ホーム</span>
        </a>
        <a href="create.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            <span data-i18n="nav.record">記録</span>
        </a>
        <a href="fortune.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <span data-i18n="nav.fortune">運勢</span>
        </a>
        <a href="graph.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            <span data-i18n="nav.graph">推移</span>
        </a>
        <a href="history.html" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span data-i18n="nav.history">履歴</span>
        </a>
    </nav>

    <style>
        .history-card-type {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: var(--font-size-xs);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            margin-left: var(--space-sm);
        }

        .history-card-type.effort {
            background: rgba(91, 110, 225, 0.2);
            color: var(--primary-light);
        }

        .history-card-type.good-thing {
            background: rgba(224, 123, 123, 0.2);
            color: var(--secondary-light);
        }

        .history-card-detail {
            font-size: var(--font-size-sm);
            opacity: 0.7;
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-map {
            work: "仕事",
            study: "勉強",
            exercise: "運動",
            health: "健康",
            hobby: "趣味",
            social: "人間関係",
            other: "その他"
        }
    </style>

    <script src="js/storage.js"></script>
    <script src="js/i18n.js"></script>
    <script>
        const categoryNames = {
            work: "仕事",
            study: "勉強",
            exercise: "運動",
            health: "健康",
            hobby: "趣味",
            social: "人間関係",
            other: "その他",
            // Legacy categories
            Test: "テスト",
            Project: "プロジェクト",
            Presentation: "プレゼン",
            Language: "語学",
            Game: "ゲーム",
            Romance: "恋愛",
            Career: "キャリア",
            Lifestyle: "ライフスタイル",
            Exam: "試験",
            Other: "その他"
        };

        let currentFilter = 'all';
        let searchQuery = '';
        let deleteTargetId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await I18n.init('ja');
            renderHistory();

            // Filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    renderHistory();
                });
            });

            // Search input
            document.getElementById('searchInput').addEventListener('input', function(e) {
                searchQuery = e.target.value.toLowerCase();
                renderHistory();
            });
        });

        function renderHistory() {
            let posts = FortuneTeller.getPostsSortedByDate();

            // Apply filter
            if (currentFilter === 'effort') {
                posts = posts.filter(p => p.effort === 1);
            } else if (currentFilter === 'goodThing') {
                posts = posts.filter(p => p.lucky === 1);
            }

            // Apply search
            if (searchQuery) {
                posts = posts.filter(p =>
                    p.title.toLowerCase().includes(searchQuery) ||
                    (p.detail && p.detail.toLowerCase().includes(searchQuery))
                );
            }

            const container = document.getElementById('historyList');

            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 8v4l3 3"/>
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <p class="empty-state-text" data-i18n="history.empty">記録がありません</p>
                        <a href="create.html" class="btn btn-primary mt-lg">記録を追加する</a>
                    </div>
                `;
                return;
            }

            // Group by date
            const grouped = {};
            posts.forEach(post => {
                if (!grouped[post.due]) {
                    grouped[post.due] = [];
                }
                grouped[post.due].push(post);
            });

            let html = '';
            for (const [date, dayPosts] of Object.entries(grouped)) {
                const dayTotal = dayPosts.reduce((sum, p) => sum + p.point, 0);

                html += `
                    <div class="daily-summary">
                        <div class="daily-summary-info">
                            <span class="daily-summary-date">${I18n.formatDate(date)}</span>
                            <span class="daily-summary-label" data-i18n="history.dailyTotal">この日の合計</span>
                        </div>
                        <span class="daily-summary-point ${dayTotal > 0 ? 'positive' : dayTotal < 0 ? 'negative' : ''}">
                            ${dayTotal > 0 ? '+' : ''}${dayTotal}pt
                        </span>
                    </div>
                `;

                dayPosts.forEach(post => {
                    const typeClass = post.effort === 1 ? 'effort' : 'good-thing';
                    const typeName = post.effort === 1 ? '努力' : '良いこと';
                    const categoryName = categoryNames[post.object] || post.object;

                    html += `
                        <div class="history-card">
                            <div class="history-card-header">
                                <span class="history-card-category">${escapeHtml(categoryName)}</span>
                                <span class="history-card-type ${typeClass}">${typeName}</span>
                                <span class="history-card-point ${post.point > 0 ? 'positive' : post.point < 0 ? 'negative' : ''}">
                                    ${post.point > 0 ? '+' : ''}${post.point}pt
                                </span>
                            </div>
                            <h3 class="history-card-title">${escapeHtml(post.title)}</h3>
                            ${post.detail ? `<p class="history-card-detail">${escapeHtml(post.detail)}</p>` : ''}
                            <div class="history-card-actions">
                                <button onclick="confirmDelete(${post.id})" class="btn btn-sm btn-danger">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                    削除
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function confirmDelete(id) {
            deleteTargetId = id;
            document.getElementById('deleteDialog').classList.add('active');
            document.getElementById('confirmDeleteBtn').onclick = function() {
                deletePost(deleteTargetId);
            };
        }

        function closeDeleteDialog() {
            document.getElementById('deleteDialog').classList.remove('active');
            deleteTargetId = null;
        }

        function deletePost(id) {
            FortuneTeller.deletePost(id);
            closeDeleteDialog();
            showToast(I18n.t('record.toast.deleted'));
            renderHistory();
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
