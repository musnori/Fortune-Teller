<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>推移グラフ - 運勢トラッカー</title>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation">
        <div class="bg-gradient"></div>
        <div class="floating-shapes">
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="app-container">
        <div class="fade-in">
            <!-- Header -->
            <header class="app-header">
                <h1 class="app-title" data-i18n="graph.title">推移グラフ</h1>
            </header>

            <!-- Period Tabs -->
            <div class="tab-nav" id="periodTabs">
                <button class="tab-btn active" data-period="7" data-i18n="graph.periods.7days">7日</button>
                <button class="tab-btn" data-period="30" data-i18n="graph.periods.30days">30日</button>
                <button class="tab-btn" data-period="all" data-i18n="graph.periods.all">全期間</button>
            </div>

            <!-- Graph Card -->
            <div class="glass-card slide-up mt-lg">
                <!-- Chart Container -->
                <div class="chart-container">
                    <canvas id="myChart"></canvas>
                </div>

                <!-- Summary Stats -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="graph.stats.total">合計</span>
                        <span class="stat-value" id="totalPoints">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="graph.stats.average">平均</span>
                        <span class="stat-value" id="avgPoints">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="graph.stats.max">最大</span>
                        <span class="stat-value" id="maxPoints">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="graph.stats.streak">連続記録</span>
                        <span class="stat-value streak" id="streakDays">--</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="btn-group mt-xl">
                <a href="create.html" class="btn btn-primary btn-lg" style="flex: 1;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    <span data-i18n="home.recordEffort">努力を記録</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <span data-i18n="nav.home">ホーム</span>
        </a>
        <a href="create.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            <span data-i18n="nav.record">記録</span>
        </a>
        <a href="fortune.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <span data-i18n="nav.fortune">運勢</span>
        </a>
        <a href="graph.html" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            <span data-i18n="nav.graph">推移</span>
        </a>
        <a href="history.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span data-i18n="nav.history">履歴</span>
        </a>
    </nav>

    <style>
        .chart-container {
            position: relative;
            height: 220px;
            margin-bottom: var(--space-xl);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-sm);
            padding-top: var(--space-lg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: var(--font-size-xs);
            opacity: 0.6;
            margin-bottom: var(--space-xs);
        }

        .stat-value {
            font-size: var(--font-size-lg);
            font-weight: 700;
        }

        .stat-value.positive {
            color: var(--accent-light);
        }

        .stat-value.negative {
            color: var(--secondary-light);
        }

        .stat-value.streak {
            color: var(--streak-color);
        }

        @media (max-width: 375px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-md);
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/i18n.js"></script>
    <script>
        let myChart = null;
        let currentPeriod = 7;

        document.addEventListener('DOMContentLoaded', async function() {
            await I18n.init('ja');
            renderChart(7);

            // Period tabs
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const period = this.dataset.period === 'all' ? 'all' : parseInt(this.dataset.period);
                    currentPeriod = period;
                    renderChart(period);
                });
            });
        });

        function getPointsForPeriod(days) {
            const posts = FortuneTeller.getPosts();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let startDate;
            if (days === 'all') {
                // Find earliest date
                if (posts.length === 0) {
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 7);
                } else {
                    const dates = posts.map(p => new Date(p.due));
                    startDate = new Date(Math.min(...dates));
                }
            } else {
                startDate = new Date(today);
                startDate.setDate(startDate.getDate() - days + 1);
            }

            const labels = [];
            const points = [];
            let currentDate = new Date(startDate);

            while (currentDate <= today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayPosts = posts.filter(p => p.due === dateStr);
                const dayTotal = dayPosts.reduce((sum, p) => sum + p.point, 0);

                labels.push(currentDate.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' }));
                points.push(dayTotal);

                currentDate.setDate(currentDate.getDate() + 1);
            }

            return { labels, points };
        }

        function renderChart(days) {
            const data = getPointsForPeriod(days);
            const labels = data.labels;
            const points = data.points;

            // Calculate stats
            const total = points.reduce((a, b) => a + b, 0);
            const nonZeroDays = points.filter(p => p !== 0).length;
            const avg = nonZeroDays > 0 ? (total / nonZeroDays).toFixed(1) : 0;
            const max = points.length ? Math.max(...points) : 0;
            const streak = FortuneTeller.getStreak();

            document.getElementById('totalPoints').textContent = total + 'pt';
            document.getElementById('avgPoints').textContent = avg + 'pt';
            document.getElementById('maxPoints').textContent = max + 'pt';
            document.getElementById('streakDays').textContent = streak + '日';

            // Apply colors based on values
            const totalEl = document.getElementById('totalPoints');
            totalEl.classList.remove('positive', 'negative');
            if (total > 0) totalEl.classList.add('positive');
            else if (total < 0) totalEl.classList.add('negative');

            // Chart.js config
            const ctx = document.getElementById('myChart').getContext('2d');

            // Destroy existing chart
            if (myChart) {
                myChart.destroy();
            }

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 220);
            gradient.addColorStop(0, 'rgba(91, 110, 225, 0.4)');
            gradient.addColorStop(1, 'rgba(91, 110, 225, 0)');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '運ポイント',
                        data: points,
                        borderColor: '#7B8EF7',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#7B8EF7',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: labels.length > 14 ? 0 : 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 40, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + 'pt';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: {
                                    size: 10
                                },
                                maxRotation: 0,
                                maxTicksLimit: labels.length > 14 ? 7 : labels.length
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return value + 'pt';
                                }
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
    </script>
</body>
</html>
